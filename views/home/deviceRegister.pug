extends ../layout

block content
    link(rel='stylesheet', href='/stylesheets/deviceTable.css')
    script(type='text/javascript' src='https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=tpkaldfehz&submodules=geocoder')

    script.
        let latitude = 35.5039678;
        let longitude = 129.3055745;
        const position = new naver.maps.LatLng(latitude, longitude);

        $(function () {
            let map = new naver.maps.Map("map", {
                center: position,
                zoom: 15,
                mapTypeControl: true
            });

            let marker = new naver.maps.Marker({
                map: map,
                position: position
            });

            let infoWindow = new naver.maps.InfoWindow({
                anchorSkew: true
            });

            map.setCursor('pointer');

            function searchCoordinateToAddress(latlng) {
                infoWindow.close();

                naver.maps.Service.reverseGeocode({
                    coords: latlng,
                    orders: [
                        naver.maps.Service.OrderType.ADDR,
                        naver.maps.Service.OrderType.ROAD_ADDR
                    ].join(',')
                }, function (status, response) {
                    if (status === naver.maps.Service.Status.ERROR) {
                        if (!latlng) {
                            return alert('ReverseGeocode Error, Please check latlng');
                        }
                        if (latlng.toString) {
                            return alert('ReverseGeocode Error, latlng:' + latlng.toString());
                        }
                        if (latlng.x && latlng.y) {
                            return alert('ReverseGeocode Error, x:' + latlng.x + ', y:' + latlng.y);
                        }
                        return alert('ReverseGeocode Error, Please check latlng');
                    }

                    let address = response.v2.address,
                        htmlAddresses = [];

                    if (address.jibunAddress !== '') {
                        $("#registerArea").val(address.jibunAddress);
                        htmlAddresses.push('[지번 주소] ' + address.jibunAddress);
                    }

                    if (address.roadAddress !== '') {
                        htmlAddresses.push('[도로명 주소] ' + address.roadAddress);
                    }

                    infoWindow.setContent([
                        '<div style="padding:10px; min-width:200px; line-height:150%; font-size: 12px">',
                        // '<h5 style="margin-top:5px;">검색 좌표</h4><br />',
                        htmlAddresses.join('<br />'),
                        '</div>'
                    ].join('\n'));

                    infoWindow.open(map, marker);
                });
            }

            function searchAddressToCoordinate(address) {
                naver.maps.Service.geocode({
                    query: address
                }, function (status, response) {
                    if (status === naver.maps.Service.Status.ERROR) {
                        if (!address) {
                            return alert('Geocode Error, Please check address');
                        }
                        return alert('Geocode Error, address:' + address);
                    }

                    if (response.v2.meta.totalCount === 0) {
                        return alert('No result.');
                    }

                    let htmlAddresses = [],
                        item = response.v2.addresses[0],
                        point = new naver.maps.Point(item.x, item.y);

                    if (item.roadAddress) {
                        htmlAddresses.push('[도로명 주소] ' + item.roadAddress);
                    }

                    if (item.jibunAddress) {
                        $("#registerArea").val(item.jibunAddress);
                        htmlAddresses.push('[지번 주소] ' + item.jibunAddress);
                    }

                    infoWindow.setContent([
                        '<div style="padding:10px;min-width:200px;line-height:150%; font-size: 12px">',
                        '<h5 style="margin-top:5px;">검색 주소 : ' + address + '</h4><br />',
                        htmlAddresses.join('<br />'),
                        '</div>'
                    ].join('\n'));

                    map.setCenter(point);
                    infoWindow.open(map, marker);
                });
            }

            function initGeocoder() {
                if (!map.isStyleMapReady) {
                    return;
                }

                map.addListener('click', function (e) {
                    // console.log("e.coord => " + e.coord);
                    // console.log("e.coord.x" + e.coord.x);
                    longitude = e.coord.x;                                      // set coordinate for DB
                    latitude = e.coord.y;                                       // set coordinate for DB
                    searchCoordinateToAddress(e.coord);
                    marker.setPosition(e.coord);
                });

                $('#address').on('keydown', function (e) {
                    let keyCode = e.which;

                    if (keyCode === 13) { // Enter Key
                        searchAddressToCoordinate($('#address').val());
                    }
                });

                $('#submit').on('click', function (e) {
                    e.preventDefault();

                    searchAddressToCoordinate($('#address').val());
                });

                searchAddressToCoordinate('테크노산업로 55번길 133-9');
            }

            naver.maps.onJSContentLoaded = initGeocoder;
            naver.maps.Event.once(map, 'init_stylemap', initGeocoder);
        });

        const selectDevice = (e) => {
            if(e.value === 'customOption') {                                                // display the input function follow with selection
                document.getElementsByName("customInput")[0].style.display = 'inline';
            }
            else {
                document.getElementsByName("customInput")[0].style.display = 'none';
            }
        }

        function uploadImgPreview() {                                                       // display picture that customer pic
            let fileInfo = document.getElementById("deviceImgInput").files[0];
            let reader = new FileReader();

            reader.onload = function() {
                document.getElementById("previewImg").src = reader.result;
            };

            if(fileInfo) {
                reader.readAsDataURL(fileInfo);
            }
        }

        function registerDevice() {
            let result = confirm("장치를 등록 하시겠습니까?")
            if(!result)
                return 0;

            let deviceType;
            if($("select[name= deviceOptions]").val() === "customOption") {                 // deviceType that customer select (option or 'customInput')
                deviceType = $("#customInput").val();
            }
            else {
                deviceType =$("select[name= deviceOptions]").val();
            }

            let form = new FormData();                                                      // I used that when I control about ImgData
            form.append("deviceImg", $("#deviceImgInput")[0].files[0]);

            $.ajax({                                                                        // register data(name, type,
                data: JSON.stringify({
                    'deviceName': $("input[name= deviceName]").val(),
                    'deviceType': deviceType,
                    'latitude': latitude,
                    'longitude': longitude
                }),
                type: 'post',
                dataType: 'html',
                url: "/deviceRegister/api/register",
                contentType: 'application/json',
                success: (result) => {
                    console.log(result)
                },
                error: (err) => {
                    console.log(err)
                }
            })

            $.ajax({                                                                        // register img src follow with deviceId
                data: form,
                type: 'post',
                processData: false,
                dataType: 'html',
                url: "/deviceRegister/api/imgUpload",
                contentType: false,
                success: (result) => {
                    console.log(result)
                    alert(result);
                    location.href = "/deviceManage";
                },
                error: (err) => {
                    console.log(err)
                }
            })
        }

    //#diviceContainer
    .row#deviceContatiner
        p#pageTitle 장치 등록
    .row#showTable
        .col-5
            table#showInfo
                thead#deviceName
                    tr
                        th 장치 명
                        td
                            input(type="text" style="width: 100%" name="deviceName")
                tbody#deviceInfo
                    tr
                        td#deviceImg(colspan="2")
                            img#previewImg(src="")
                    tr
                        td(colspan="2")
                            input(type="file" id="deviceImgInput" name="deviceImgInput" style="width: 100%" accept="image/*" onchange="uploadImgPreview()")

                    tr
                        th 등록 장소
                        td
                            input#registerArea(type="text" disabled = true style="width: 100%")
                    tr
                        th 장치 타입
                        td
                            select#selectDevice(name="deviceOptions" style="width: 100%; text-align: center" onchange="selectDevice(this)")
                                option(value = 'customOption') 사용자 입력
                                -for (let i = 0; i < deviceData.length; i++)
                                    option(value = `${deviceData[i].deviceType}`) #{deviceData[i].deviceType}
                            input#customInput(type="text" name="customInput" style="width: 100%")
                    tr
                        th 등록 일
                        td
                            input(type="text" disabled = true style="width: 100%" value=`${currentTime}`)
        .col
            .row
                input#address(type="text")
                button#submit() search
            .row#map

    .row
        table#buttonTable
            tr
                td(colspan="2")
                    button(onClick='registerDevice()' class='btn btn-dark mr-2' style="width: 90%") 장치 등록
            tr
                td(colspan="2")
                    button(onClick='location.href = "/deviceManage"' class='btn btn-dark mr-2' style="width: 90%") 뒤로 가기
